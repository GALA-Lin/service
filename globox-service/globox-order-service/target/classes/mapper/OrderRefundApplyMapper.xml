<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.unlimited.sports.globox.order.mapper.OrderRefundApplyMapper">


    <select id="selectMerchantRefundApplyPage" resultType="com.unlimited.sports.globox.dubbo.order.dto.MerchantRefundApplyPageResultDto">
        SELECT
        ra.id              AS refundApplyId,
        ra.order_no        AS orderNo,
        o.buyer_id         AS userId,
        o.seller_id        AS venueId,
        o.order_status     AS orderStatus,
        ra.apply_status    AS applyStatus,
        ra.reason_code     AS reasonCode,
        ra.reason_detail   AS reasonDetail,
        ra.created_at      AS appliedAt,
        ra.reviewed_at     AS reviewedAt
        FROM order_refund_apply ra
        INNER JOIN orders o
        ON ra.order_no = o.order_no
        AND o.deleted = 0
        WHERE ra.deleted = 0
        AND o.seller_type = 1
        AND o.seller_id IN
        <foreach collection="dto.venueIds" item="vid" open="(" close=")" separator=",">
            #{vid}
        </foreach>

        <if test="dto.applyStatus != null">
            AND ra.apply_status = #{dto.applyStatus}
        </if>

        <if test="dto.orderNo != null">
            AND ra.order_no = #{dto.orderNo}
        </if>

        <if test="dto.userId != null">
            AND o.buyer_id = #{dto.userId}
        </if>

        <if test="dto.appliedAtStart != null">
            AND ra.created_at &gt;= #{dto.appliedAtStart}
        </if>

        <if test="dto.appliedAtEnd != null">
            AND ra.created_at &lt;= #{dto.appliedAtEnd}
        </if>

        ORDER BY ra.created_at DESC
    </select>
</mapper>
