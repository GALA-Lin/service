<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.unlimited.sports.globox.venue.mapper.VenuePriceOverrideMapper">

    <!-- 查询指定场馆在指定日期和时间段的价格覆盖 -->
    <select id="selectByVenueAndTimeRange" resultType="com.unlimited.sports.globox.model.venue.entity.booking.VenuePriceOverride">
        SELECT
            override_id AS overrideId,
            venue_id AS venueId,
            court_id AS courtId,
            override_date AS overrideDate,
            start_time AS startTime,
            end_time AS endTime,
            override_price AS overridePrice,
            description,
            is_enabled AS isEnabled,
            created_at AS createdAt,
            updated_at AS updatedAt
        FROM venue_price_override
        WHERE venue_id = #{venueId}
          AND override_date = #{date}
          AND is_enabled = 1
          <!-- 时间段重叠判断：start_time < endTime AND end_time > startTime -->
          AND start_time &lt; #{endTime}
          AND end_time &gt; #{startTime}
          <!-- 场地过滤：court_id 为 NULL（场馆级）或匹配指定场地 -->
          AND (court_id IS NULL OR court_id = #{courtId})
        <!-- 按优先级排序：场地级优先（court_id IS NOT NULL），然后按 start_time 排序 -->
        ORDER BY court_id IS NULL ASC, start_time ASC
    </select>

    <!-- 查询指定场馆在指定日期的所有价格覆盖 -->
    <select id="selectByVenueIdAndDate" resultType="com.unlimited.sports.globox.model.venue.entity.booking.VenuePriceOverride">
        SELECT
            override_id AS overrideId,
            venue_id AS venueId,
            court_id AS courtId,
            override_date AS overrideDate,
            start_time AS startTime,
            end_time AS endTime,
            override_price AS overridePrice,
            description,
            is_enabled AS isEnabled,
            created_at AS createdAt,
            updated_at AS updatedAt
        FROM venue_price_override
        WHERE venue_id = #{venueId}
          AND override_date = #{date}
          AND is_enabled = 1
        ORDER BY start_time ASC
    </select>

    <!-- 查询指定场地在指定日期的所有价格覆盖 -->
    <select id="selectByCourtIdAndDate" resultType="com.unlimited.sports.globox.model.venue.entity.booking.VenuePriceOverride">
        SELECT
            override_id AS overrideId,
            venue_id AS venueId,
            court_id AS courtId,
            override_date AS overrideDate,
            start_time AS startTime,
            end_time AS endTime,
            override_price AS overridePrice,
            description,
            is_enabled AS isEnabled,
            created_at AS createdAt,
            updated_at AS updatedAt
        FROM venue_price_override
        WHERE court_id = #{courtId}
          AND override_date = #{date}
          AND is_enabled = 1
        ORDER BY start_time ASC
    </select>

    <!-- 批量查询指定场馆列表在指定日期的价格覆盖 -->
    <select id="selectByVenueIdsAndDate" resultType="com.unlimited.sports.globox.model.venue.entity.booking.VenuePriceOverride">
        SELECT
            override_id AS overrideId,
            venue_id AS venueId,
            court_id AS courtId,
            override_date AS overrideDate,
            start_time AS startTime,
            end_time AS endTime,
            override_price AS overridePrice,
            description,
            is_enabled AS isEnabled,
            created_at AS createdAt,
            updated_at AS updatedAt
        FROM venue_price_override
        WHERE venue_id IN
        <foreach collection="venueIds" item="venueId" open="(" separator="," close=")">
            #{venueId}
        </foreach>
          AND override_date = #{date}
          AND is_enabled = 1
        ORDER BY venue_id, court_id IS NULL ASC, start_time ASC
    </select>

</mapper>
