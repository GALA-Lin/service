<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.unlimited.sports.globox.social.mapper.ConversationMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.unlimited.sports.globox.model.social.entity.Conversation">
        <id column="conversation_id" property="conversationId"/>
        <result column="conversation_type" property="conversationType"/>
        <result column="sender_user_id" property="senderUserId"/>
        <result column="receive_user_id" property="receiveUserId"/>
        <result column="conversation_name_sender" property="conversationNameSender"/>
        <result column="conversation_avatar_sender" property="conversationAvatarSender"/>
        <result column="conversation_name_receiver" property="conversationNameReceiver"/>
        <result column="conversation_avatar_receiver" property="conversationAvatarReceiver"/>
        <result column="last_message_id" property="lastMessageId"/>
        <result column="last_message_content" property="lastMessageContent"/>
        <result column="last_message_type" property="lastMessageType"/>
        <result column="last_message_at" property="lastMessageAt"/>
        <result column="unread_count_sender" property="unreadCountSender"/>
        <result column="unread_count_receiver" property="unreadCountReceiver"/>
        <result column="is_blocked" property="isBlocked"/>
        <result column="blocked_by_user_id" property="blockedByUserId"/>
        <result column="is_pinned_sender" property="isPinnedSender"/>
        <result column="is_pinned_receiver" property="isPinnedReceiver"/>
        <result column="is_deleted_sender" property="isDeletedSender"/>
        <result column="is_deleted_receiver" property="isDeletedReceiver"/>
        <result column="extra" property="extra"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <!-- 基础列 -->
    <sql id="Base_Column_List">
        conversation_id, conversation_type, sender_user_id, receive_user_id, 
        conversation_name_sender, conversation_avatar_sender, conversation_name_receiver, conversation_avatar_receiver, last_message_id, last_message_content,
        last_message_type, last_message_at, unread_count_sender, unread_count_receiver, 
        is_blocked, blocked_by_user_id, is_pinned_sender, is_pinned_receiver, 
        is_deleted_sender, is_deleted_receiver, extra, created_at, updated_at
     </sql>

    <!-- 根据用户ID查询会话列表 -->
    <select id="selectByUserId" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM conversation
        WHERE (sender_user_id = #{userId} AND is_deleted_sender = 0)
        OR (receive_user_id = #{userId} AND is_deleted_receiver = 0)
        ORDER BY last_message_at DESC
    </select>

    <!-- 查询两个用户之间的会话 -->
    <select id="selectByUserPair" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM conversation
        WHERE ((sender_user_id = #{userId1} AND receive_user_id = #{userId2})
        OR (sender_user_id = #{userId2} AND receive_user_id = #{userId1}))
        LIMIT 1
    </select>

    <!-- 更新会话置顶状态 -->
    <update id="updatePinned">
        UPDATE conversation
        SET is_pinned_sender = CASE WHEN sender_user_id = #{userId} THEN #{isPinned} ELSE is_pinned_sender END,
        is_pinned_receiver = CASE WHEN receive_user_id = #{userId} THEN #{isPinned} ELSE is_pinned_receiver END,
        updated_at = NOW()
        WHERE conversation_id = #{conversationId}
    </update>

    <!-- 更新会话屏蔽状态 -->
    <update id="updateBlocked">
        UPDATE conversation
        SET is_blocked = #{isBlocked},
        blocked_by_user_id = CASE WHEN #{isBlocked} = true THEN #{userId} ELSE NULL END,
        updated_at = NOW()
        WHERE conversation_id = #{conversationId}
    </update>

    <!-- 清除未读计数 -->
    <update id="clearUnreadCount">
        UPDATE conversation
        SET unread_count_sender = CASE WHEN sender_user_id = #{userId} THEN 0 ELSE unread_count_sender END,
        unread_count_receiver = CASE WHEN receive_user_id = #{userId} THEN 0 ELSE unread_count_receiver END,
        updated_at = NOW()
        WHERE conversation_id = #{conversationId}
    </update>

    <!-- 标记会话已读 -->
    <update id="markConversationRead">
        UPDATE conversation
        SET unread_count_receiver = CASE WHEN receive_user_id = #{userId} THEN 0 ELSE unread_count_receiver END,
        updated_at = NOW()
        WHERE conversation_id = #{conversationId}
    </update>

    <!-- 逻辑删除会话 -->
    <update id="logicalDelete">
        UPDATE conversation
        SET is_deleted_sender = CASE WHEN sender_user_id = #{userId} THEN 1 ELSE is_deleted_sender END,
        is_deleted_receiver = CASE WHEN receive_user_id = #{userId} THEN 1 ELSE is_deleted_receiver END,
        updated_at = NOW()
        WHERE conversation_id = #{conversationId}
    </update>

    <!-- 更新最后消息信息 -->
    <update id="updateLastMessage">
        UPDATE conversation
        SET last_message_id = #{messageId},
        last_message_content = #{content},
        last_message_type = #{messageType},
        last_message_at = NOW(),
        updated_at = NOW()
        WHERE conversation_id = #{conversationId}
    </update>

    <!-- 更新未读计数（发送方+1） -->
    <update id="incrementSenderUnread">
        UPDATE conversation
        SET unread_count_sender = unread_count_sender + 1,
        last_message_at = NOW(),
        updated_at = NOW()
        WHERE conversation_id = #{conversationId}
    </update>

    <!-- 更新未读计数（接收方+1） -->
    <update id="incrementReceiverUnread">
        UPDATE conversation
        SET unread_count_receiver = unread_count_receiver + 1,
        last_message_at = NOW(),
        updated_at = NOW()
        WHERE conversation_id = #{conversationId}
    </update>

    <!-- 更新发送方的未读计数 -->
    <update id="updateSenderUnreadCount">
        UPDATE conversation
        SET unread_count_sender = #{unreadCount},
        updated_at = NOW()
        WHERE conversation_id = #{conversationId}
    </update>

    <!-- 更新接收方的未读计数 -->
    <update id="updateReceiverUnreadCount">
        UPDATE conversation
        SET unread_count_receiver = #{unreadCount},
        updated_at = NOW()
        WHERE conversation_id = #{conversationId}
    </update>

    <update id="resetUnreadCount">
        UPDATE conversation
        SET unread_count_receiver =
                CASE
                    WHEN sender_user_id = #{userId} THEN unread_count_receiver
                    WHEN receiver_user_id = #{userId} THEN 0
                    END,
            updated_at = NOW()
        WHERE id = #{conversationId}
          AND (sender_user_id = #{userId} OR receiver_user_id = #{userId})
    </update>


    <!-- 查询会话详情 -->
    <select id="selectByConversationId" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM conversation
        WHERE conversation_id = #{conversationId}
        AND is_deleted_sender = 0 AND is_deleted_receiver = 0
    </select>

    <!-- 插入会话 -->
    <insert id="insertConversation" parameterType="com.unlimited.sports.globox.model.social.entity.Conversation">
        INSERT INTO conversation (
            conversation_id,
            conversation_type,
            sender_user_id,
            receive_user_id,
            conversation_name_sender,
            conversation_avatar_sender,
            conversation_name_receiver,
            conversation_avatar_receiver,
            last_message_id,
            last_message_content,
            last_message_type,
            last_message_at,
            unread_count_sender,
            unread_count_receiver,
            is_blocked,
            blocked_by_user_id,
            is_pinned_sender,
            is_pinned_receiver,
            is_deleted_sender,
            is_deleted_receiver,
            extra,
            created_at,
            updated_at
        ) VALUES (
            #{conversationId},
            #{conversationType},
            #{senderUserId},
            #{receiveUserId},
            #{conversationNameSender},
            #{conversationAvatarSender},
            #{conversationNameReceiver},
            #{conversationAvatarReceiver},
            #{lastMessageId},
            #{lastMessageContent},
            #{lastMessageType},
            #{lastMessageAt},
            #{unreadCountSender},
            #{unreadCountReceiver},
            #{isBlocked},
            #{blockedByUserId},
            #{isPinnedSender},
            #{isPinnedReceiver},
            #{isDeletedSender},
            #{isDeletedReceiver},
            #{extra},
            #{createdAt},
            #{updatedAt}
        )
    </insert>

    <!-- 根据用户ID查询会话列表 -->
    <select id="selectByUserIdWithPagination" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM conversation
        WHERE (sender_user_id = #{userId} AND is_deleted_sender = 0)
        OR (receive_user_id = #{userId} AND is_deleted_receiver = 0)
        ORDER BY last_message_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 根据用户ID查询会话总数 -->
    <select id="countByUserId" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM conversation
        WHERE (sender_user_id = #{userId} AND is_deleted_sender = 0)
        OR (receive_user_id = #{userId} AND is_deleted_receiver = 0)
    </select>

</mapper>
