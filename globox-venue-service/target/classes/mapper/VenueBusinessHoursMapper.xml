<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.unlimited.sports.globox.merchant.mapper.VenueBusinessHoursMapper">

    <!-- 查询指定时段内不可预订的场馆ID列表
         基于营业时间规则优先级：关闭 > 特殊 > 常规
         如果场馆没有任何营业时间配置，则默认不营业
    -->
    <select id="selectUnavailableVenueIdsByBusinessHours" resultType="java.lang.Long">
        SELECT DISTINCT vbh.venue_id
        FROM venue_business_hours vbh
        WHERE (
            -- 1. CLOSED_DATE：当天关闭
            (
                vbh.rule_type = 3
                AND vbh.effective_date = #{targetDate}
            )

            OR

            -- 2. SPECIAL_DATE：当天特殊营业，但时间不覆盖
            (
                vbh.rule_type = 2
                AND vbh.effective_date = #{targetDate}
                AND NOT (
                    vbh.open_time &lt; #{endTime}
                    AND vbh.close_time &gt; #{startTime}
                )
            )

            OR

            -- 3. REGULAR：无 SPECIAL/CLOSED 覆盖，常规营业时间不覆盖
            (
                vbh.rule_type = 1
                AND NOT EXISTS (
                    SELECT 1
                    FROM venue_business_hours x
                    WHERE x.venue_id = vbh.venue_id
                      AND x.effective_date = #{targetDate}
                      AND x.rule_type IN (2, 3)
                )
                AND NOT (
                    vbh.open_time &lt; #{endTime}
                    AND vbh.close_time &gt; #{startTime}
                )
            )
        )

        UNION

        -- 4. 没有任何营业时间配置的场馆（默认不营业）
        SELECT v.venue_id
        FROM venues v
        WHERE NOT EXISTS (
            SELECT 1
            FROM venue_business_hours vbh2
            WHERE vbh2.venue_id = v.venue_id
        )
    </select>

</mapper>
