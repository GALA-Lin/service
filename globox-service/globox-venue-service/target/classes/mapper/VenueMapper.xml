<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.unlimited.sports.globox.merchant.mapper.VenueMapper">

    <!-- 场馆搜索  版本：在数据库层面进行多条件过滤和排序 -->
    <select id="searchVenues" resultType="map">
        SELECT
            v.venue_id as venueId,
            v.name,
            v.region,
            v.address,
            v.latitude,
            v.longitude,
            v.image_urls as imageUrls,
            v.min_price as minPrice,
            v.avg_rating as avgRating,
            v.rating_count as ratingCount,
            COUNT(DISTINCT c.court_id) as courtCount,
            ROUND(ACOS(SIN(RADIANS(v.latitude)) * SIN(RADIANS(#{userLat})) +
                       COS(RADIANS(v.latitude)) * COS(RADIANS(#{userLat})) *
                       COS(RADIANS(#{userLng} - v.longitude))) * 6371, 2) as distance
        FROM venues v
        LEFT JOIN courts c ON v.venue_id = c.venue_id AND c.status = 1
        WHERE 1=1
            AND v.status = 1
            <if test="keyword != null and keyword != ''">
                AND (v.name LIKE CONCAT('%', #{keyword}, '%')
                     OR v.address LIKE CONCAT('%', #{keyword}, '%')
                     OR v.region LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="minPrice != null">
                AND v.min_price >= #{minPrice}
            </if>
            <if test="maxPrice != null">
                AND v.min_price &lt;= #{maxPrice}
            </if>
            <if test="facilityVenueIds != null and facilityVenueIds.size() > 0">
                AND v.venue_id IN
                <foreach collection="facilityVenueIds" item="id" open="(" separator="," close=")">
                    #{id}
                </foreach>
            </if>
            <if test="courtTypeVenueIds != null and courtTypeVenueIds.size() > 0">
                AND v.venue_id IN
                <foreach collection="courtTypeVenueIds" item="id" open="(" separator="," close=")">
                    #{id}
                </foreach>
            </if>
            <if test="unavailableVenueIds != null and unavailableVenueIds.size() > 0">
                AND v.venue_id NOT IN
                <foreach collection="unavailableVenueIds" item="id" open="(" separator="," close=")">
                    #{id}
                </foreach>
            </if>
        GROUP BY v.venue_id
        HAVING 1=1
            <if test="minCourtCount != null">
                AND COUNT(DISTINCT c.court_id) >= #{minCourtCount}
            </if>
            <if test="maxCourtCount != null">
                AND COUNT(DISTINCT c.court_id) &lt;= #{maxCourtCount}
            </if>
            <if test="maxDistance != null">
                AND ACOS(SIN(RADIANS(v.latitude)) * SIN(RADIANS(#{userLat})) +
                         COS(RADIANS(v.latitude)) * COS(RADIANS(#{userLat})) *
                         COS(RADIANS(#{userLng} - v.longitude))) * 6371 &lt;= #{maxDistance}
            </if>
        ORDER BY
            <choose>
                <when test="sortBy == 'price'">
                    v.min_price ASC, distance ASC
                </when>
                <when test="sortBy == 'courtCount'">
                    courtCount DESC, distance ASC
                </when>
                <otherwise>
                    distance ASC, v.min_price ASC
                </otherwise>
            </choose>
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 场馆搜索计数 V2 版本：使用子查询处理GROUP BY/HAVING -->
    <select id="countSearchVenues" resultType="long">
        SELECT COUNT(*) FROM (
            SELECT v.venue_id
            FROM venues v
            LEFT JOIN courts c ON v.venue_id = c.venue_id AND c.status = 1
            WHERE 1=1
                AND v.status = 1
                <if test="keyword != null and keyword != ''">
                    AND (v.name LIKE CONCAT('%', #{keyword}, '%')
                         OR v.address LIKE CONCAT('%', #{keyword}, '%')
                         OR v.region LIKE CONCAT('%', #{keyword}, '%'))
                </if>
                <if test="minPrice != null">
                    AND v.min_price >= #{minPrice}
                </if>
                <if test="maxPrice != null">
                    AND v.min_price &lt;= #{maxPrice}
                </if>
                <if test="facilityVenueIds != null and facilityVenueIds.size() > 0">
                    AND v.venue_id IN
                    <foreach collection="facilityVenueIds" item="id" open="(" separator="," close=")">
                        #{id}
                    </foreach>
                </if>
                <if test="courtTypeVenueIds != null and courtTypeVenueIds.size() > 0">
                    AND v.venue_id IN
                    <foreach collection="courtTypeVenueIds" item="id" open="(" separator="," close=")">
                        #{id}
                    </foreach>
                </if>
                <if test="unavailableVenueIds != null and unavailableVenueIds.size() > 0">
                    AND v.venue_id NOT IN
                    <foreach collection="unavailableVenueIds" item="id" open="(" separator="," close=")">
                        #{id}
                    </foreach>
                </if>
            GROUP BY v.venue_id
            HAVING 1=1
                <if test="minCourtCount != null">
                    AND COUNT(DISTINCT c.court_id) >= #{minCourtCount}
                </if>
                <if test="maxCourtCount != null">
                    AND COUNT(DISTINCT c.court_id) &lt;= #{maxCourtCount}
                </if>
                <if test="maxDistance != null">
                    AND ACOS(SIN(RADIANS(v.latitude)) * SIN(RADIANS(#{userLat})) +
                             COS(RADIANS(v.latitude)) * COS(RADIANS(#{userLat})) *
                             COS(RADIANS(#{userLng} - v.longitude))) * 6371 &lt;= #{maxDistance}
                </if>
        ) AS filtered_venues
    </select>

    <!-- 查询不符合时间可见性规则的场馆ID列表 -->
    <select id="selectVenuesViolatingVisibilityRules" resultType="java.lang.Long">
        SELECT venue_id
        FROM venues
        WHERE
            -- 1. 未配置maxAdvanceDays的场馆（强制要求配置）
            (max_advance_days IS NULL OR max_advance_days &lt; 0)

            OR

            -- 2. 预订日期超过maxAdvanceDays的场馆
            (DATEDIFF(#{bookingDate}, CURDATE()) &gt; max_advance_days)

            OR

            -- 3. 预订今天但还未到slotVisibilityTime的场馆
            (
                #{bookingDate} = CURDATE()
                AND CURTIME() &lt; IFNULL(slot_visibility_time, '00:00:00')
            )
    </select>

</mapper>
